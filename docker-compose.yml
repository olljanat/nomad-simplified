services:
  nomad:
    image: ghcr.io/olljanat/nomad-simplified:${VERSION}
    container_name: nomad${NOMAD_NODE_NUM}
    hostname: nomad${NOMAD_NODE_NUM}
    command: nomad agent -server -config=/etc/nomad.d -config=/etc/nomad.d/role/server.hcl -bind=${NODE_IP} -region=${REGION} -dc=${DATACENTER}
    # entrypoint: /bin/client-entry.sh
    # command: nomad agent -client -config=/etc/nomad.d -config=/etc/nomad.d/role/client.hcl -region=${REGION} -dc=${DATACENTER} -node-pool=${NODE_POOL}
    environment:
      NODE_IP: ${NODE_IP}
      SERVER1: ${SERVER1}
      SERVER2: ${SERVER2}
      SERVER3: ${SERVER3}
    network_mode: host
    uts: host
    pid: host
    ipc: host
    privileged: true
    restart: always
    healthcheck:
      test:
      - CMD
      - /bin/sh
      - -c
      - wget --no-check-certificate -O - -q "https://${NOMAD_NODE_IP}:4646/v1/agent/health" | grep -q '{"server":{"message":"ok","ok":true}}'
      interval: 5s
      timeout: 1s
      retries: 1
      start_period: 30s

    # Trigger graceful shutdown with SIGINT which Nomad agent is listening
    # and give it 5 minutes handle active connections before killing container
    stop_grace_period: 5m
    stop_signal: SIGINT

    volumes:
    - nomad:/opt/nomad
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./tls:/opt/tls:ro

  coredns:
    image: ghcr.io/olljanat/nomad-simplified:${VERSION}
    container_name: nomad${NOMAD_NODE_NUM}-coredns
    command: coredns -conf /etc/coredns/Corefile
    environment:
      NOMAD_TOKEN: ${COREDNS_NOMAD_TOKEN}
      NOMAD_SKIP_VERIFY: "true"
      SERVER1: ${SERVER1}
      SERVER2: ${SERVER2}
      SERVER3: ${SERVER3}
      DOMAIN: service.nomad
    network_mode: host
    uts: host
    pid: host
    ipc: host
    privileged: true
    restart: always
    healthcheck:
      test:
      - CMD
      - /bin/sh
      - -c
      - wget -O - -q "http://127.0.0.1:8080/health" | grep -q 'OK'
      interval: 5s
      timeout: 1s
      retries: 1
      start_period: 30s

    # Trigger graceful shutdown with SIGINT which CoreDNS is listening
    # and give it 1 minute handle active connections before killing container
    stop_grace_period: 1m
    stop_signal: SIGINT

volumes:
  nomad:
    name: nomad
    driver: local
